#! /bin/bash
# -*- mode: sh -*-
#
# Simple notes
# Author: Victor Ananjevsky <ananasik@gmail.com>, 2010-2012
#

TEXTDOMAIN=@GETTEXT_PACKAGE@
TEXTDOMAINDIR=@prefix@/share/locale

PIDFILE=/var/run/ynotes.pid
touch $PIDFILE

NOTES_FILE=${XDG_CACHE_HOME:-$HOME/.cache}/ydesk/notes
NOTES_TITLE=$"Notes"
export NOTES_FILE NOTES_TITLE

function show_note () {
    xlsclients | grep -q "Ynotes-txt" || yad --sticky --name="Ynotes-txt" \
        --width=400 --height=250 --posx=-2 --posy=-2 \
        --window-icon="ynotes" --no-buttons --title="$NOTES_TITLE" \
        --text-info --show-uri --editable --always-print-result \
        --lang="makrdown" --filename=$NOTES_FILE > /tmp/.notes
    [[ $? -eq 0 ]] && mv -f /tmp/.notes $NOTES_FILE
}
export -f show_note

# check if we are already running
NPID=$(< $PIDFILE)
if pkill -0 -- ${NPID:--1}; then
    kill -USR1 $NPID
    exit 0
else
    echo $$ > $PIDFILE
    trap show_note USR1
fi

mkdir -p $(dirname $NOTES_FILE)
touch $NOTES_FILE

exec yad --notification --name="Ynotes" --text=$"Text notes" --image="ynotes" --command "sh -c show_note"
