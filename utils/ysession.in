#! /bin/bash
#
# Start Ydesk session
#

shopt -s nocasematch

prefix=@prefix@
exec_prefix=@exec_prefix@
libdir=@libdir@/ydesk
sysconfdir=@sysconfdir@/ydesk

trap '' SIGCHLD

# make sure misc bin directory in PATH
export PATH="$libdir/bin:$PATH"

# create xdg user directory structure
userconfdir="${XDG_CONFIG_HOME:-$HOME/.config}/ydesk"
mkdir -p $userconfdir

usercachedir="${XDG_CACHE_HOME:-$HOME/.cache}/ydesk"
mkdir -p $usercachedir

# set xdg session name
export XDG_CURRENT_DESKTOP="YDESK"

# make sure some service directories exists
[[ -n $XDG_RUNTIME_DIR ]] && mkdir -p $XDG_RUNTIME_DIR
[[ -n $GNUPGHOME ]] && mkdir -m 0700 -p $GNUPGHOME

# load some specific X resources
AD_DIR=${XDG_DATA_HOME:-$HOME:/.share}/app-defaults
mkdir -p $AD_DIR && touch $AD_DIR/empty.ad
cat $AD_DIR/*.ad | xrdb -merge

# load settings
eval UPDATE_USERDIRS=$(gsettings get ydesk.session userdirs)
eval RUN_EMACS=$(gsettings get ydesk.session run-emacs)
eval RUN_RXVT=$(gsettings get ydesk.session run-rxvt)
eval BACKGROUND=$(gsettings get ydesk.session bg)
eval WALLPAPER=$(gsettings get ydesk.session wallpaper)
eval ENABLE_COMPOSE=$(gsettings get ydesk.session compose)

# recreate user directories tree
[[ $UPDATE_USERDIRS == true ]] && xdg-user-dirs-update --force

# run emacs server
[[ $RUN_EMACS == true && -x $(command -v emacs) ]] && emacs --daemon

# run rxvt server
[[ $RUN_RXVT == true && -x $(command -v urxvtd) ]] && urxvtd -q -o -f

# set root window background
if [[ -e $WALLPAPER ]]; then
    fvwm-root -r $WALLPAPER
else
    xsetroot -solid ${BACKGROUND:-#071a30}
fi

# compositing
[[ $ENABLE_COMPOSE == true && $(command -v xcompmgr) ]] && xcompmgr -c -t-5 -l-5 -r4.2 -o.55 &> /dev/null &

# set fvwm variables
FVWM_LIBDIR="$libdir/fvwm"
FVWM_DATADIR="$prefix/share/ydesk/fvwm"
FVWM_USERDIR="$userconfdir/fvwm"
FVWM_CACHEDIR="$usercachedir/fvwm"
export FVWM_LIBDIR FVWM_DATADIR FVWM_USERDIR FVWM_CACHEDIR

mkdir -p $FVWM_USERDIR $FVWM_CACHEDIR /tmp/ydesk

# recreate fvwm configs
touch $FVWM_USERDIR/custom.fvwm
cat > $FVWM_USERDIR/config <<EOF
# Do not edit this file, it will be regenerated at restart

SetEnv FVWM_DATADIR $FVWM_DATADIR

Read main.fvwm
Read colors.fvwm
Read decor.fvwm
Read functions.fvwm
Read menus.fvwm
Read keys.fvwm
Read modules.fvwm 
Read custom.fvwm
EOF

# run fvwm
exec fvwm -f $FVWM_USERDIR/config
